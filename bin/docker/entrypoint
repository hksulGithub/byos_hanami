#! /usr/bin/env ruby
# frozen_string_literal: true

require "pathname"

$VERBOSE = true

jemalloc_path = Dir["/usr/lib/*/libjemalloc.so.2"]
ENV["LD_PRELOAD"] = jemalloc_path.first unless ENV.key?("LD_PRELOAD") || jemalloc_path.empty?

system "bundle exec hanami assets compile"
system "bundle exec hanami db migrate"

%w[firmware screen model].each do |poller|
  pid = spawn "bin/pollers/#{poller}"
  Process.detach pid
end

exec(*ARGV)
